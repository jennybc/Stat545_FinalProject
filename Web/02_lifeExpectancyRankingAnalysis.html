

<!DOCTYPE html>
<html>
<head>
<style type="text/css">.knitr.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
},
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0em 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage.left {
  text-align: left;
}
.rimage.right {
  text-align: right;
}
.rimage.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}</style>
  <title>A Report Generated by knitr</title>
</head>
<body>

  <p>This report is automatically generated with the R
    package <a href="http://yihui.name/knitr"><strong>knitr</strong></a>
    (version <code class="knitr inline">1.4.1</code>)
    .</p>

<div class="chunk" id="auto-report"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">library</span><span class="hl std">(ggplot2)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Loading required package: methods
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">library</span><span class="hl std">(plyr)</span>
<span class="hl std">dat</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">read.delim</span><span class="hl std">(</span><span class="hl str">&quot;Data/gapminder_clean.tsv&quot;</span><span class="hl std">)</span>
<span class="hl kwd">tail</span><span class="hl std">(dat)</span>
</pre></div>
<div class="output"><pre class="knitr r">##             country year      pop continent lifeExp gdpPercap
## 1675 United Kingdom 1982 56339704    Europe   74.04     18232
## 1676 United Kingdom 1987 56981620    Europe   75.01     21665
## 1677 United Kingdom 1992 57866349    Europe   76.42     22705
## 1678 United Kingdom 1997 58808266    Europe   77.22     26075
## 1679 United Kingdom 2002 59912431    Europe   78.47     29479
## 1680 United Kingdom 2007 60776238    Europe   79.42     33203
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">## infer order of continent from order in file</span>
<span class="hl std">id</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">unique</span><span class="hl std">(dat</span><span class="hl opt">$</span><span class="hl std">continent)</span>
<span class="hl std">dat</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">within</span><span class="hl std">(dat, {</span>
    <span class="hl std">continent</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">factor</span><span class="hl std">(</span><span class="hl kwd">as.character</span><span class="hl std">(continent),</span> <span class="hl kwc">levels</span> <span class="hl std">= id)</span>
<span class="hl std">})</span>
<span class="hl com">## JB's warning on this method for reordering factors: WARNING: probably not a safe long-run</span>
<span class="hl com">## strategy for communicating factor level order with plain text data files; I see no</span>
<span class="hl com">## guarantees that unique() return value will be in any particular order; I have just</span>
<span class="hl com">## noticed anecdotally that return value is in order of appearance</span>
<span class="hl kwd">table</span><span class="hl std">(dat</span><span class="hl opt">$</span><span class="hl std">continent)</span>  <span class="hl com"># ensure that the ordering is still in place</span>
</pre></div>
<div class="output"><pre class="knitr r">## 
##   Africa     Asia Americas   Europe 
##      624      396      300      360
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">## linear regression with coefficients</span>
<span class="hl std">yearMin</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">min</span><span class="hl std">(dat</span><span class="hl opt">$</span><span class="hl std">year)</span>
<span class="hl std">LifeExpRegression</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">) {</span>
    <span class="hl std">fit</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">lm</span><span class="hl std">(lifeExp</span> <span class="hl opt">~</span> <span class="hl kwd">I</span><span class="hl std">(year</span> <span class="hl opt">-</span> <span class="hl std">yearMin), x)</span>
    <span class="hl std">estCoefs</span> <span class="hl kwb">&lt;-</span> <span class="hl std">fit</span><span class="hl opt">$</span><span class="hl std">coefficients</span>
    <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">int</span> <span class="hl std">= estCoefs[</span><span class="hl num">1</span><span class="hl std">],</span> <span class="hl kwc">m</span> <span class="hl std">= estCoefs[</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl kwc">sd</span> <span class="hl std">=</span> <span class="hl kwd">sqrt</span><span class="hl std">(</span><span class="hl kwd">deviance</span><span class="hl std">(fit)</span><span class="hl opt">/</span><span class="hl kwd">df.residual</span><span class="hl std">(fit)),</span>
        <span class="hl kwc">maxResid</span> <span class="hl std">=</span> <span class="hl kwd">max</span><span class="hl std">(</span><span class="hl kwd">abs</span><span class="hl std">(</span><span class="hl kwd">resid</span><span class="hl std">(fit)))))</span>
<span class="hl std">}</span>
<span class="hl std">lifeExpLM_all</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ddply</span><span class="hl std">(dat,</span> <span class="hl opt">~</span><span class="hl std">country</span> <span class="hl opt">+</span> <span class="hl std">continent, LifeExpRegression)</span>
<span class="hl kwd">write.table</span><span class="hl std">(lifeExpLM_all,</span> <span class="hl str">&quot;Results/lifeExpLM_all.tsv&quot;</span><span class="hl std">,</span> <span class="hl kwc">quote</span> <span class="hl std">=</span> <span class="hl num">FALSE</span><span class="hl std">,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;\t&quot;</span><span class="hl std">,</span> <span class="hl kwc">row.names</span> <span class="hl std">=</span> <span class="hl num">FALSE</span><span class="hl std">)</span>
<span class="hl com">## what are the 3-4 best and worst countries for each contient I use the same metric that we</span>
<span class="hl com">## used in class, namely the max resid (there are some problems with this approach, but that</span>
<span class="hl com">## is not the purpose of this assignment)</span>
<span class="hl std">Extremes</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">) {</span>
    <span class="hl std">m</span> <span class="hl kwb">&lt;-</span> <span class="hl num">3</span>  <span class="hl com">#number of extreme values to take from the tails</span>
    <span class="hl std">n</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">nrow</span><span class="hl std">(x)</span>
    <span class="hl std">id</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">sort</span><span class="hl std">(x</span><span class="hl opt">$</span><span class="hl std">maxResid,</span> <span class="hl kwc">index.return</span> <span class="hl std">= T)</span><span class="hl opt">$</span><span class="hl std">ix</span>
    <span class="hl std">best</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">data.frame</span><span class="hl std">(x[id[(n</span> <span class="hl opt">-</span> <span class="hl std">m</span> <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl std">)</span><span class="hl opt">:</span><span class="hl std">n], ],</span> <span class="hl kwc">extreme</span> <span class="hl std">=</span> <span class="hl str">&quot;worst&quot;</span><span class="hl std">)</span>
    <span class="hl std">worst</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">data.frame</span><span class="hl std">(x[id[</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl std">m], ],</span> <span class="hl kwc">extreme</span> <span class="hl std">=</span> <span class="hl str">&quot;best&quot;</span><span class="hl std">)</span>
    <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl kwd">rbind</span><span class="hl std">(best, worst))</span>
<span class="hl std">}</span>
<span class="hl std">lifeExpLM_extremes</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ddply</span><span class="hl std">(lifeExpLM_all,</span> <span class="hl opt">~</span><span class="hl std">continent, Extremes)</span>
<span class="hl kwd">write.table</span><span class="hl std">(lifeExpLM_extremes,</span> <span class="hl str">&quot;Results/lifeExpLM_extremes.tsv&quot;</span><span class="hl std">,</span> <span class="hl kwc">quote</span> <span class="hl std">=</span> <span class="hl num">FALSE</span><span class="hl std">,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;\t&quot;</span><span class="hl std">,</span>
    <span class="hl kwc">row.names</span> <span class="hl std">=</span> <span class="hl num">FALSE</span><span class="hl std">)</span>
<span class="hl com">## reorder before merge in an attempt to fix plotting issue:: makes no difference</span>
<span class="hl std">lifeExpLM_extremes</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">within</span><span class="hl std">(lifeExpLM_extremes, {</span>
    <span class="hl std">continent</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">factor</span><span class="hl std">(</span><span class="hl kwd">as.character</span><span class="hl std">(continent),</span> <span class="hl kwc">levels</span> <span class="hl std">= id)</span>
<span class="hl std">})</span>
<span class="hl com">## single page figures for each continent from those extreme countries and write to file.</span>
<span class="hl com">## The error here is debugged in 03_debugBlankFigure</span>
<span class="hl std">lifeExpLM_extremesAgg</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">merge</span><span class="hl std">(dat, lifeExpLM_extremes)</span>
<span class="hl std">lifeExpLM_extremesAgg</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">within</span><span class="hl std">(lifeExpLM_extremesAgg, country</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">reorder</span><span class="hl std">(country,</span> <span class="hl opt">-</span><span class="hl std">maxResid))</span>
<span class="hl kwd">d_ply</span><span class="hl std">(lifeExpLM_extremesAgg,</span> <span class="hl opt">~</span><span class="hl std">continent,</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">z</span><span class="hl std">) {</span>
    <span class="hl std">sContinent</span> <span class="hl kwb">&lt;-</span> <span class="hl std">z</span><span class="hl opt">$</span><span class="hl std">continent[</span><span class="hl num">1</span><span class="hl std">]</span>
    <span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ggplot</span><span class="hl std">()</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg, continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent),</span>
        <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= year,</span> <span class="hl kwc">y</span> <span class="hl std">= lifeExp,</span> <span class="hl kwc">color</span> <span class="hl std">= extreme))</span>
    <span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl std">p</span> <span class="hl opt">+</span> <span class="hl kwd">geom_abline</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">intercept</span> <span class="hl std">= int</span> <span class="hl opt">-</span> <span class="hl std">m</span> <span class="hl opt">*</span> <span class="hl std">yearMin,</span> <span class="hl kwc">slope</span> <span class="hl std">= m),</span> <span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg,</span>
        <span class="hl std">continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent))</span> <span class="hl opt">+</span> <span class="hl kwd">facet_wrap</span><span class="hl std">(</span><span class="hl opt">~</span><span class="hl std">country)</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;Extreme Life Expectancy Trends in &quot;</span><span class="hl std">,</span>
        <span class="hl std">sContinent,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">))</span>
    <span class="hl kwd">ggsave</span><span class="hl std">(</span><span class="hl kwc">filename</span> <span class="hl std">=</span> <span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;res_extremeLifeExpectancy_&quot;</span><span class="hl std">, sContinent,</span> <span class="hl str">&quot;.png&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">),</span> <span class="hl kwc">plot</span> <span class="hl std">= p,</span>
        <span class="hl kwc">path</span> <span class="hl std">=</span> <span class="hl str">&quot;Figures&quot;</span><span class="hl std">,</span> <span class="hl kwc">width</span> <span class="hl std">=</span> <span class="hl num">14.4</span><span class="hl std">,</span> <span class="hl kwc">height</span> <span class="hl std">=</span> <span class="hl num">10.9</span><span class="hl std">)</span>
<span class="hl std">})</span>
</pre></div>
<div class="error"><pre class="knitr r">## Error: object 'yearMin' not found
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 3.0.1 (2013-05-16)
## Platform: x86_64-apple-darwin10.8.0 (64-bit)
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
## [1] plyr_1.8        ggplot2_0.9.3.1
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_1.2-2   dichromat_2.0-0    digest_0.6.3       evaluate_0.4.7    
##  [5] formatR_0.9        grid_3.0.1         gtable_0.1.2       highr_0.2.1       
##  [9] knitr_1.4.1        labeling_0.2       MASS_7.3-26        munsell_0.4.2     
## [13] proto_0.3-10       RColorBrewer_1.0-5 reshape2_1.2.2     scales_0.2.3      
## [17] stringr_0.6.2      tools_3.0.1
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] "2013-10-20 14:59:03 PDT"
</pre></div>
</div></div>


  <p>The R session information (including the OS info, R version and all
    packages used):</p>

<div class="chunk" id="session-info"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 3.0.1 (2013-05-16)
## Platform: x86_64-apple-darwin10.8.0 (64-bit)
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
## [1] plyr_1.8        ggplot2_0.9.3.1
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_1.2-2   dichromat_2.0-0    digest_0.6.3       evaluate_0.4.7    
##  [5] formatR_0.9        grid_3.0.1         gtable_0.1.2       highr_0.2.1       
##  [9] knitr_1.4.1        labeling_0.2       MASS_7.3-26        munsell_0.4.2     
## [13] proto_0.3-10       RColorBrewer_1.0-5 reshape2_1.2.2     scales_0.2.3      
## [17] stringr_0.6.2      tools_3.0.1
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] "2013-10-20 14:59:03 PDT"
</pre></div>
</div></div>




</body>
</html>

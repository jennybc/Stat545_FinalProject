

<!DOCTYPE html>
<html>
<head>
<style type="text/css">.knitr.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
},
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0em 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage.left {
  text-align: left;
}
.rimage.right {
  text-align: right;
}
.rimage.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}</style>
  <title>A Report Generated by knitr</title>
</head>
<body>

  <p>This report is automatically generated with the R
    package <a href="http://yihui.name/knitr"><strong>knitr</strong></a>
    (version <code class="knitr inline">1.4.1</code>)
    .</p>

<div class="chunk" id="auto-report"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com">## Examine the plotting behaviour of ggsave and png() to try and determine why the plot will</span>
<span class="hl com">## generate when sourced and run interactively in console, but not through R CMD BATCH</span>
<span class="hl com">## Here is an illustration of the problem</span>
<span class="hl kwd">library</span><span class="hl std">(ggplot2)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Loading required package: methods
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">library</span><span class="hl std">(plyr)</span>
<span class="hl std">dat</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">read.delim</span><span class="hl std">(</span><span class="hl str">&quot;Data/gapminder_clean.tsv&quot;</span><span class="hl std">)</span>
<span class="hl std">lifeExpLM_extremes</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">read.delim</span><span class="hl std">(</span><span class="hl str">&quot;Results/lifeExpLM_extremes.tsv&quot;</span><span class="hl std">)</span>
<span class="hl std">yearMin</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">min</span><span class="hl std">(dat</span><span class="hl opt">$</span><span class="hl std">year)</span>
<span class="hl std">lifeExpLM_extremesAgg</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">merge</span><span class="hl std">(dat, lifeExpLM_extremes)</span>
<span class="hl std">lifeExpLM_extremesAgg1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">within</span><span class="hl std">(lifeExpLM_extremesAgg, country</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">reorder</span><span class="hl std">(country,</span> <span class="hl opt">-</span><span class="hl std">maxResid))</span>
<span class="hl com">## With this command sequence the first plot should generate a blank image</span>
<span class="hl kwd">d_ply</span><span class="hl std">(lifeExpLM_extremesAgg,</span> <span class="hl opt">~</span><span class="hl std">continent,</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">z</span><span class="hl std">) {</span>
    <span class="hl std">sContinent</span> <span class="hl kwb">&lt;-</span> <span class="hl std">z</span><span class="hl opt">$</span><span class="hl std">continent[</span><span class="hl num">1</span><span class="hl std">]</span>
    <span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ggplot</span><span class="hl std">()</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg, continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent),</span>
        <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= year,</span> <span class="hl kwc">y</span> <span class="hl std">= lifeExp,</span> <span class="hl kwc">color</span> <span class="hl std">= extreme))</span>
    <span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl std">p</span> <span class="hl opt">+</span> <span class="hl kwd">geom_abline</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">intercept</span> <span class="hl std">= int</span> <span class="hl opt">-</span> <span class="hl std">m</span> <span class="hl opt">*</span> <span class="hl std">yearMin,</span> <span class="hl kwc">slope</span> <span class="hl std">= m),</span> <span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg,</span>
        <span class="hl std">continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent))</span> <span class="hl opt">+</span> <span class="hl kwd">facet_wrap</span><span class="hl std">(</span><span class="hl opt">~</span><span class="hl std">country)</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;Extreme Life Expectancy Trends in &quot;</span><span class="hl std">,</span>
        <span class="hl std">sContinent,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">))</span>
    <span class="hl kwd">ggsave</span><span class="hl std">(</span><span class="hl kwc">filename</span> <span class="hl std">=</span> <span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;res_extremeLifeExpectancy_&quot;</span><span class="hl std">, sContinent,</span> <span class="hl str">&quot;.png&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">),</span> <span class="hl kwc">plot</span> <span class="hl std">= p,</span>
        <span class="hl kwc">path</span> <span class="hl std">=</span> <span class="hl str">&quot;Figures/Debug&quot;</span><span class="hl std">,</span> <span class="hl kwc">width</span> <span class="hl std">=</span> <span class="hl num">14.4</span><span class="hl std">,</span> <span class="hl kwc">height</span> <span class="hl std">=</span> <span class="hl num">10.9</span><span class="hl std">)</span>
<span class="hl std">})</span>
</pre></div>
<div class="error"><pre class="knitr r">## Error: object 'yearMin' not found
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">## Strange! This is a different resut than the same set of commands in an earlier file.  The</span>
<span class="hl com">## only difference is the input data, where in the first file it was been sorted on a levels</span>
<span class="hl com">## basis, however here there is no sorting. Levels and factors are evil. This still does not</span>
<span class="hl com">## provide an answer for why in-console or console sourcing the other file works, whereas R</span>
<span class="hl com">## CMD BATCH fails...on the same file! Are the levels handled differently in different</span>
<span class="hl com">## environments? Does RStudio not use the same environment as R base? Afterall, RStudio</span>
<span class="hl com">## should sit ontop of the base installation.</span>
<span class="hl com">## I have tired to implement a reorder in the other file but that has failed as well.  Since</span>
<span class="hl com">## I have isolated the error to some data/levels/factor issue I don't think it is necessary</span>
<span class="hl com">## to implement a base R graphics version of these charts.</span>
<span class="hl com">## Test for another continent outside of the d_ply call with ggsave Note: including the plot</span>
<span class="hl com">## argument, and not printing the image before</span>
<span class="hl std">sContinent</span> <span class="hl kwb">&lt;-</span> <span class="hl str">&quot;Europe&quot;</span>
<span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ggplot</span><span class="hl std">()</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg, continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent),</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= year,</span>
    <span class="hl kwc">y</span> <span class="hl std">= lifeExp,</span> <span class="hl kwc">color</span> <span class="hl std">= extreme))</span>
<span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl std">p</span> <span class="hl opt">+</span> <span class="hl kwd">geom_abline</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">intercept</span> <span class="hl std">= int</span> <span class="hl opt">-</span> <span class="hl std">m</span> <span class="hl opt">*</span> <span class="hl std">yearMin,</span> <span class="hl kwc">slope</span> <span class="hl std">= m),</span> <span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg,</span>
    <span class="hl std">continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent))</span> <span class="hl opt">+</span> <span class="hl kwd">facet_wrap</span><span class="hl std">(</span><span class="hl opt">~</span><span class="hl std">country)</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;Extreme Life Expectancy Trends in &quot;</span><span class="hl std">,</span>
    <span class="hl std">sContinent,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">))</span>
<span class="hl kwd">ggsave</span><span class="hl std">(</span><span class="hl kwc">filename</span> <span class="hl std">=</span> <span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;res_extremeLifeExpectancy_ggsave_noLoop&quot;</span><span class="hl std">, sContinent,</span> <span class="hl str">&quot;.png&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">),</span>
    <span class="hl kwc">plot</span> <span class="hl std">= p,</span> <span class="hl kwc">path</span> <span class="hl std">=</span> <span class="hl str">&quot;Figures/Debug&quot;</span><span class="hl std">,</span> <span class="hl kwc">width</span> <span class="hl std">=</span> <span class="hl num">14.4</span><span class="hl std">,</span> <span class="hl kwc">height</span> <span class="hl std">=</span> <span class="hl num">10.9</span><span class="hl std">)</span>
</pre></div>
<div class="error"><pre class="knitr r">## Error: object 'yearMin' not found
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">## Try with png</span>
<span class="hl kwd">png</span><span class="hl std">(</span><span class="hl kwc">filename</span> <span class="hl std">=</span> <span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;Figures/Debug/res_extremeLifeExpectancy_pngSaveOnlyPrint_noLoop&quot;</span><span class="hl std">, sContinent,</span>
    <span class="hl str">&quot;.png&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">))</span>
<span class="hl kwd">print</span><span class="hl std">(p)</span>
</pre></div>
<div class="error"><pre class="knitr r">## Error: object 'yearMin' not found
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">dev.off</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## pdf 
##   2
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">## Try with png, create the ggplot within the png call</span>
<span class="hl kwd">png</span><span class="hl std">(</span><span class="hl kwc">filename</span> <span class="hl std">=</span> <span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;Figures/Debug/res_extremeLifeExpectancy_pngGenerateInPNG_noLoop&quot;</span><span class="hl std">, sContinent,</span>
    <span class="hl str">&quot;.png&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">))</span>
<span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ggplot</span><span class="hl std">()</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg, continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent),</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= year,</span>
    <span class="hl kwc">y</span> <span class="hl std">= lifeExp,</span> <span class="hl kwc">color</span> <span class="hl std">= extreme))</span>
<span class="hl std">p</span> <span class="hl kwb">&lt;-</span> <span class="hl std">p</span> <span class="hl opt">+</span> <span class="hl kwd">geom_abline</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">intercept</span> <span class="hl std">= int</span> <span class="hl opt">-</span> <span class="hl std">m</span> <span class="hl opt">*</span> <span class="hl std">yearMin,</span> <span class="hl kwc">slope</span> <span class="hl std">= m),</span> <span class="hl kwc">data</span> <span class="hl std">=</span> <span class="hl kwd">subset</span><span class="hl std">(lifeExpLM_extremesAgg,</span>
    <span class="hl std">continent</span> <span class="hl opt">==</span> <span class="hl std">sContinent))</span> <span class="hl opt">+</span> <span class="hl kwd">facet_wrap</span><span class="hl std">(</span><span class="hl opt">~</span><span class="hl std">country)</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl kwd">paste</span><span class="hl std">(</span><span class="hl str">&quot;Extreme Life Expectancy Trends in &quot;</span><span class="hl std">,</span>
    <span class="hl std">sContinent,</span> <span class="hl kwc">sep</span> <span class="hl std">=</span> <span class="hl str">&quot;&quot;</span><span class="hl std">))</span>
<span class="hl kwd">print</span><span class="hl std">(p)</span>
</pre></div>
<div class="error"><pre class="knitr r">## Error: object 'yearMin' not found
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">dev.off</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## pdf 
##   2
</pre></div>
<div class="source"><pre class="knitr r">

</pre></div>
</div></div>


  <p>The R session information (including the OS info, R version and all
    packages used):</p>

<div class="chunk" id="session-info"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 3.0.1 (2013-05-16)
## Platform: x86_64-apple-darwin10.8.0 (64-bit)
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
## [1] plyr_1.8        ggplot2_0.9.3.1
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_1.2-2   dichromat_2.0-0    digest_0.6.3       evaluate_0.4.7    
##  [5] formatR_0.9        grid_3.0.1         gtable_0.1.2       highr_0.2.1       
##  [9] knitr_1.4.1        labeling_0.2       MASS_7.3-26        munsell_0.4.2     
## [13] proto_0.3-10       RColorBrewer_1.0-5 reshape2_1.2.2     scales_0.2.3      
## [17] stringr_0.6.2      tools_3.0.1
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] "2013-10-20 14:59:17 PDT"
</pre></div>
</div></div>




</body>
</html>
